<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Лодка — демо игра</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(#0079c9, #0059a5);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .game {
            position: relative;
            width: 100%;
            max-width: 480px;
            height: 100vh;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        .hidden { display: none !important; }

        :root {
            --boat-frames: 30;
            --wake-frames: 30;
            --chest-frames: 30;
        }

        /* ---------- Водные частицы ---------- */

        .water-fx {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .bubble {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: rgba(255,255,255,0.85);
            box-shadow: 0 0 6px rgba(255,255,255,0.9);
            opacity: 0.9;
            animation: bubbleUp 2.4s linear forwards;
        }
        @keyframes bubbleUp {
            0%   { transform: translate(-50%,0) scale(1);   opacity: .9; }
            100% { transform: translate(-50%,-40px) scale(.4); opacity: 0; }
        }

        .water-wave {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid rgba(160,210,255,0.5);
            background: radial-gradient(circle, rgba(160,210,255,0.35), transparent 60%);
            opacity: 0.8;
            pointer-events: none;
            animation: waveExpand 2.5s ease-out forwards;
        }
        @keyframes waveExpand {
            0%   { transform: translate(-50%,-50%) scale(.4); opacity:.7; }
            100% { transform: translate(-50%,-50%) scale(3.3);opacity:0; }
        }

        /* ---------- Боковой фон (острова) ---------- */

        .sides {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        .side {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 130px;
        }
        .side.left  {
            left: -130px;              /* полоса уходит за левый край */
            transform: scaleX(-1);     /* зеркалим */
            transform-origin: right center;
        }
        .side.right { right: 0; }

        .bg-strip {
            position: absolute;
            left: 0;
            width: 100%;
            height: 130vh;
            background-size: auto 33.333%;  /* островы меньше в 3 раза по высоте */
            background-position: right top;  /* правый край спрайта по правому краю полосы */
            background-repeat: no-repeat;
            will-change: transform;
        }

        /* ---------- Слой сундуков ---------- */

        .chests-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 2;
        }
        .chest {
            position: absolute;
            width: 54px;
            height: 54px;
            transform: translate(-50%, -50%);
            background-size: calc(var(--chest-frames) * 100%) 100%;
            background-position: 0% 0%;
            background-repeat: no-repeat;
        }

        /* ---------- Верхний множитель ---------- */

        .multiplier {
            position: relative;
            z-index: 3;
            margin-top: 40px;
            font-size: 40px;
            font-weight: 700;
            text-align: center;
        }

        /* ---------- Лодка + шлейф ---------- */

        .boat-area {
            position: relative;
            z-index: 3;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .boat-wrap {
            width: 50px;    /* уменьшенный корабль */
            height: 140px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            will-change: transform, opacity;
            transform-origin: 50% 70%; /* поворот почти вокруг центра лодки */
            z-index: 3;
        }

        .boat {
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 3;
            background-image: url("img/c2c0f618-0470-4e03-9f95-449f3f41e764.webp");
            background-size: calc(var(--boat-frames) * 100%) 100%;
            background-position: 0% 100%;
            background-repeat: no-repeat;
        }

        .boat-wake {
            position: absolute;
            z-index: 2;
            left: 50%;
            top: 52%;
            transform: translate(-50%, 0);
            width: 120px;
            height: 170px;
            opacity: 0;
            background-image: url("img/boat_wake.webp");
            background-size: calc(var(--wake-frames) * 100%) 100%;
            background-position: 0% 0%;
            background-repeat: no-repeat;
            pointer-events: none;
        }

        @keyframes float {
            0%   { transform: translateY(0); }
            50%  { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }
        .boat.moving {
            animation: float 1.4s ease-in-out infinite;
        }

        @keyframes sail-away {
            0% {
                transform: translateX(var(--boat-x, 0)) translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateX(var(--boat-x, 0)) translateY(-130vh) scale(0.4);
                opacity: 0;
            }
        }
        .boat-wrap.sail-away {
            animation: sail-away 1.6s ease-in forwards;
        }

        /* ---------- Текст бонуса от сундука ---------- */

        .bonus-text {
            position: absolute;
            z-index: 4;
            pointer-events: none;
            font-size: 14px;
            font-weight: 700;
            color: #7dff9d;
            text-shadow: 0 0 4px rgba(0,0,0,0.7);
            animation: chestBonusFloat 0.8s ease-out forwards;
        }
        @keyframes chestBonusFloat {
            0%   { transform: translate(-50%, 0);    opacity: 1; }
            100% { transform: translate(-50%, -20px); opacity: 0; }
        }

        /* ---------- Результат ---------- */

        .result {
            position: absolute;
            top: 26%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 4;
        }
        .result-mult {
            font-size: 34px;
            font-weight: 700;
            color: #7dff9d;
        }
        .result-text {
            margin-top: 4px;
            font-size: 14px;
            opacity: 0.9;
        }

        /* ---------- Кнопка «удерживать» ---------- */

        .hold-area {
            position: relative;
            z-index: 4;
            margin-top: 8px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .hold-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            background: #e0edf8;
            position: relative;
            cursor: pointer;
            touch-action: none;
        }
        .hold-btn::before,
        .hold-btn::after {
            content: "";
            position: absolute;
            inset: -4px;
            border-radius: inherit;
            border: 2px solid rgba(255,255,255,0.7);
            opacity: 0.5;
            animation: ripple 1.6s infinite;
        }
        .hold-btn::after {
            inset: -10px;
            opacity: 0.3;
            animation-delay: 0.4s;
        }
        @keyframes ripple {
            0%   { transform: scale(0.9); opacity: 0.5; }
            70%  { transform: scale(1.1); opacity: 0; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        .hold-label {
            margin-top: 6px;
            font-size: 12px;
            opacity: 0.9;
            text-align: center;
        }

        /* ---------- Панель ставок / кэшаут ---------- */

        .bet-area {
            position: relative;
            z-index: 4;
            width: 100%;
            margin-top: 4px;
        }
        .bet-header {
            font-size: 11px;
            opacity: 0.7;
            margin: 0 2px 4px;
        }
        .bet-main,
        .cashout-main {
            border-radius: 14px;
            padding: 6px;
            display: flex;
            align-items: center;
        }
        .bet-main {
            background: rgba(0,0,0,0.28);
        }
        .bet-main.hidden { display: none; }

        .bet-btn {
            flex: 0 0 46px;
            height: 32px;
            border-radius: 10px;
            border: none;
            background: rgba(0,0,0,0.45);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        .bet-btn:active { transform: translateY(1px); }

        .bet-amount-input {
            flex: 1;
            height: 32px;
            margin: 0 6px;
            border-radius: 10px;
            border: none;
            background: rgba(0,0,0,0.3);
            color: #fff;
            text-align: center;
            font-size: 16px;
            outline: none;
        }
        .bet-amount-input::-webkit-outer-spin-button,
        .bet-amount-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .bet-amount-input[type=number] { -moz-appearance: textfield; }
        .bet-amount-input.error { outline: 2px solid #ff6b6b; }

        .cashout-main {
            margin-top: 6px;
            width: 100%;
            height: 46px;
            border-radius: 18px;
            background: linear-gradient(90deg,#4da5ff,#61d4ff);
            color: #ffffff;
            font-weight: 600;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            display: none;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.35);
        }
        .cashout-main.visible { display: flex; }

        .cashout-amount {
            font-size: 17px;
            line-height: 1.1;
        }
        .cashout-label {
            font-size: 11px;
            line-height: 1.1;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            opacity: 0.95;
        }

        .bet-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            font-size: 11px;
            opacity: 0.7;
        }
        .autoplay.disabled,
        .last-mult.disabled { color: rgba(255,255,255,0.5); }

        .balance-bar {
            position: relative;
            z-index: 4;
            width: 100%;
            margin-top: 4px;
            font-size: 12px;
            text-align: right;
            opacity: 0.9;
        }
    </style>
</head>
<body>
<div class="game">

    <!-- Водные частицы -->
    <div class="water-fx" id="waterFx"></div>

    <!-- Боковой фон -->
    <div class="sides">
        <div class="side left"  id="sideLeft"></div>
        <div class="side right" id="sideRight"></div>
    </div>

    <!-- Слой сундуков -->
    <div class="chests-layer" id="chestsLayer"></div>

    <!-- Текущий множитель -->
    <div class="multiplier" id="multiplierDisplay">x1.00</div>

    <!-- Лодка + шлейф -->
    <div class="boat-area">
        <div class="boat-wrap" id="boatWrap">
            <div class="boat-wake" id="boatWake"></div>
            <div class="boat" id="boat"></div>
        </div>
    </div>

    <!-- Результат -->
    <div class="result hidden" id="resultBlock">
        <div class="result-mult" id="resultMult">x1.00</div>
        <div class="result-text">
            Вы выиграли <span id="resultWinAmount">+0.00 ₽</span>
        </div>
    </div>

    <!-- Кнопка "удерживайте" -->
    <div class="hold-area">
        <button class="hold-btn" id="holdBtn"
                aria-label="Удерживайте, чтобы сделать ставку"></button>
        <div class="hold-label">Удерживайте, чтобы сделать ставку</div>
    </div>

    <!-- Панель ставок / кэшаут -->
    <div class="bet-area">
        <div class="bet-header">Больше ставок</div>

        <div class="bet-main" id="betMain">
            <button class="bet-btn" id="btnHalf">½</button>
            <button class="bet-btn" id="btnMinus">−</button>
            <input id="betInput" class="bet-amount-input"
                   type="number" min="0.01" step="0.01" value="1.00">
            <button class="bet-btn" id="btnPlus">+</button>
            <button class="bet-btn" id="btnDouble">x2</button>
        </div>

        <button class="cashout-main" id="cashoutMain">
            <div class="cashout-amount">0.00 ₽</div>
            <div class="cashout-label">ЗАБРАТЬ</div>
        </button>

        <div class="bet-footer">
            <div class="autoplay disabled">Автоигра</div>
            <div class="last-mult disabled" id="lastMult">0.00x</div>
        </div>
    </div>

    <div class="balance-bar">
        Баланс: <span id="balanceValue">10000.00</span> ₽
    </div>
</div>

<script>
    /* --- DOM ссылки --- */
    const gameEl       = document.querySelector('.game');
    const waterFx      = document.getElementById('waterFx');
    const multiplierEl = document.getElementById('multiplierDisplay');

    const boatWrap     = document.getElementById('boatWrap');
    const boatEl       = document.getElementById('boat');
    const wakeEl       = document.getElementById('boatWake');
    const holdBtn      = document.getElementById('holdBtn');

    const chestsLayer  = document.getElementById('chestsLayer');

    const resultBlock  = document.getElementById('resultBlock');
    const resultMultEl = document.getElementById('resultMult');
    const resultWinEl  = document.getElementById('resultWinAmount');

    const betInput     = document.getElementById('betInput');
    const btnHalf      = document.getElementById('btnHalf');
    const btnMinus     = document.getElementById('btnMinus');
    const btnPlus      = document.getElementById('btnPlus');
    const btnDouble    = document.getElementById('btnDouble');
    const betMain      = document.getElementById('betMain');
    const cashoutMain  = document.getElementById('cashoutMain');
    const cashoutAmount= cashoutMain.querySelector('.cashout-amount');
    const lastMultEl   = document.getElementById('lastMult');
    const balanceValueEl = document.getElementById('balanceValue');

    const sideLeft     = document.getElementById('sideLeft');
    const sideRight    = document.getElementById('sideRight');

    /* --- Константы --- */
    const WATER_SPEED  = 120; // px/сек

    // лодка
    const BOAT_FRAMES   = 30;
    const BOAT_FPS      = 30;
    const BOAT_FRAME_MS = 1000 / BOAT_FPS;

    // сундуки
    const CHEST_IDLE_FRAMES = 25;
    const CHEST_HIT_FRAMES  = 36;
    const CHEST_IDLE_FPS    = 25;
    const CHEST_HIT_FPS     = 35;
    const CHEST_IDLE_SPRITE = '7cb6bdc9-573b-4b7b-9128-33b3ac9a5781.webp';
    const CHEST_HIT_SPRITE  = 'f880e728-dfc0-4727-a186-70fdde575079.webp';

    // стороны
    const SIDE_COUNT  = 22;
    const SIDE_CHANCE = 0.8;
    const sideImages  = Array.from(
        {length: SIDE_COUNT},
        (_,i) => `img/side${i+1}.webp`
    );

    /* --- Состояние игры --- */
    let state = 'idle';          // idle | running | finished
    let multiplier = 1;
    let growTimer = null;
    let demoBalance = 10000;

    // лодка: плавный поворот
    let boatOffsetX = 0;
    let boatTargetOffsetX = 0;
    let dragStartX = 0;
    let dragStartOffset = 0;
    let activePointerId = null;
    let maxBoatOffset = 1;
    let turning = false;

    // лодка: кадры спрайта
    let boatFrameIndex = 0;
    let boatFrameTimer = null;

    // сундуки
    const chests = [];
    let chestCooldown = 0;
    let lastChestGroupCenterX = null;

    // стороны
    const sidePairs = []; // {leftEl,rightEl,baseY,offset}
    let bgInitialized = false;
    let scrolling = false;
    let lastTime = 0;

    // вода
    let bubbleTimer = 0;
    let waveTimer   = 0;

    /* -------- Лодка: спрайт -------- */
    function updateBoatFrame() {
        const p = (boatFrameIndex / (BOAT_FRAMES - 1)) * 100;
        boatEl.style.backgroundPosition = `${p}% 100%`;
        wakeEl.style.backgroundPosition = `${p}% 0%`;
    }

    function startBoatFrames() {
        stopBoatFrames();
        boatFrameIndex = 0;
        updateBoatFrame();
        wakeEl.style.opacity = 0.85;
        boatFrameTimer = setInterval(() => {
            boatFrameIndex = (boatFrameIndex + 1) % BOAT_FRAMES;
            updateBoatFrame();
        }, BOAT_FRAME_MS);
    }

    function stopBoatFrames() {
        if (boatFrameTimer) {
            clearInterval(boatFrameTimer);
            boatFrameTimer = null;
        }
        wakeEl.style.opacity = 0;
    }

    /* -------- Лодка: плавный поворот -------- */

    function applyBoatTransform() {
        const maxAngle = 18;
        const denom = maxBoatOffset || 1;
        const t = Math.max(-1, Math.min(1, boatOffsetX / denom));
        const angle = t * maxAngle;
        boatWrap.style.transform = `translateX(${boatOffsetX}px) rotate(${angle}deg)`;
    }

    function boatTurnLoop() {
        if (!turning) return;
        boatOffsetX += (boatTargetOffsetX - boatOffsetX) * 0.18;
        applyBoatTransform();
        requestAnimationFrame(boatTurnLoop);
    }

    /* -------- Множитель -------- */
    function updateMultiplierUI() {
        multiplierEl.textContent = 'x' + multiplier.toFixed(2);
    }

    function startGrowing() {
        multiplier = 1;
        updateMultiplierUI();
        multiplierEl.classList.remove('hidden');
        boatEl.classList.add('moving');
        startBoatFrames();
        turning = true;
        boatTurnLoop();

        growTimer = setInterval(() => {
            multiplier += 0.02;
            updateMultiplierUI();
        }, 40);
    }

    function stopGrowing() {
        clearInterval(growTimer);
        growTimer = null;
        boatEl.classList.remove('moving');
        stopBoatFrames();
        turning = false;
    }

    /* -------- Ставка -------- */
    function getBet() {
        const v = parseFloat(String(betInput.value).replace(',', '.'));
        if (isNaN(v) || v <= 0) return null;
        return v;
    }
    function setBet(v) {
        if (!v || v <= 0) v = 0.01;
        betInput.value = v.toFixed(2);
    }
    const BET_STEP = 1;
    btnHalf  .addEventListener('click', () => { if (state==='idle') setBet((getBet()||0)/2); });
    btnDouble.addEventListener('click', () => { if (state==='idle') setBet((getBet()||0)*2); });
    btnMinus .addEventListener('click', () => { if (state==='idle') setBet((getBet()||0)-BET_STEP); });
    btnPlus  .addEventListener('click', () => { if (state==='idle') setBet((getBet()||0)+BET_STEP); });
    betInput .addEventListener('change', () => setBet(getBet()));

    /* -------- Движение лодки (таргет-позиция) -------- */
    function handleBoatMove(e) {
        if (state !== 'running') return;
        if (e.pointerId !== activePointerId) return;
        e.preventDefault();

        const dx = e.clientX - dragStartX;
        maxBoatOffset = gameEl.clientWidth * 0.35;

        let target = dragStartOffset + dx;
        if (target >  maxBoatOffset) target =  maxBoatOffset;
        if (target < -maxBoatOffset) target = -maxBoatOffset;

        boatTargetOffsetX = target;
    }

    /* -------- Сундуки -------- */

    function spawnChestAtX(x, y) {
        const el = document.createElement('div');
        el.className = 'chest';
        el.style.backgroundImage = `url("img/${CHEST_IDLE_SPRITE}")`;
        chestsLayer.appendChild(el);

        const chest = {
            el,
            x,
            y,
            state: 'idle',
            frame: 0,
            timer: null
        };
        chests.push(chest);
        updateChestElement(chest);
        startChestIdleAnimation(chest);
    }

    function spawnChestGroup() {
        const gameRect = gameEl.getBoundingClientRect();
        const laneWidth = gameRect.width * 0.5;
        const centerX = gameRect.width / 2;

        // распределение: 1 ~70%, 2 ~20%, 3 ~10%
        const r = Math.random();
        let count;
        if (r < 0.7) count = 1;
        else if (r < 0.9) count = 2;
        else count = 3;

        const spacing = 62;

        const groupHalfWidth = (count - 1) * spacing / 2;
        const laneHalf = laneWidth/2 - groupHalfWidth - 20;
        let baseCenter = centerX + (Math.random()*2 - 1) * laneHalf;

        if (lastChestGroupCenterX !== null &&
            Math.abs(baseCenter - lastChestGroupCenterX) < spacing * 0.6) {
            baseCenter += (baseCenter < centerX ? -1 : 1) * spacing;
        }
        const minCenter = centerX - laneWidth/2 + groupHalfWidth + 20;
        const maxCenter = centerX + laneWidth/2 - groupHalfWidth - 20;
        if (baseCenter < minCenter) baseCenter = minCenter;
        if (baseCenter > maxCenter) baseCenter = maxCenter;
        lastChestGroupCenterX = baseCenter;

        const baseY = -40 - Math.random()*60;

        for (let i = 0; i < count; i++) {
            const offset = (i - (count-1)/2) * spacing;
            let x = baseCenter + offset + (Math.random()*2 - 1) * 10;
            const minX = centerX - laneWidth/2 + 30;
            const maxX = centerX + laneWidth/2 - 30;
            if (x < minX) x = minX;
            if (x > maxX) x = maxX;

            const y = baseY + (Math.random()*2 - 1) * 10;
            spawnChestAtX(x, y);
        }
    }

    function startChestIdleAnimation(ch) {
        if (ch.timer) { clearInterval(ch.timer); ch.timer = null; }
        ch.state = 'idle';
        ch.frame = 0;
        ch.el.style.backgroundImage = `url("img/${CHEST_IDLE_SPRITE}")`;
        ch.el.style.backgroundPosition = '0% 0%';
        ch.el.style.backgroundSize = `${CHEST_IDLE_FRAMES * 100}% 100%`;

        const frameMs = 1000 / CHEST_IDLE_FPS;
        ch.timer = setInterval(() => {
            if (ch.state !== 'idle') return;
            ch.frame = (ch.frame + 1) % CHEST_IDLE_FRAMES;
            const p = (ch.frame / (CHEST_IDLE_FRAMES - 1)) * 100;
            ch.el.style.backgroundPosition = `${p}% 0%`;
        }, frameMs);
    }

    function startChestHitAnimation(ch) {
        if (ch.timer) { clearInterval(ch.timer); ch.timer = null; }
        ch.state = 'hit';
        ch.frame = 0;
        ch.el.style.backgroundImage = `url("img/${CHEST_HIT_SPRITE}")`;
        ch.el.style.backgroundPosition = '0% 0%';
        ch.el.style.backgroundSize = `${CHEST_HIT_FRAMES * 100}% 100%`;

        const frameMs = 1000 / CHEST_HIT_FPS;
        ch.timer = setInterval(() => {
            if (ch.state !== 'hit') return;
            ch.frame++;
            if (ch.frame >= CHEST_HIT_FRAMES) {
                clearInterval(ch.timer);
                ch.timer = null;
                ch.state = 'dead';
                ch.el.remove();
                const idx = chests.indexOf(ch);
                if (idx !== -1) chests.splice(idx, 1);
                return;
            }
            const p = (ch.frame / (CHEST_HIT_FRAMES - 1)) * 100;
            ch.el.style.backgroundPosition = `${p}% 0%`;
        }, frameMs);
    }

    function updateChestElement(ch) {
        ch.el.style.left = ch.x + 'px';
        ch.el.style.top  = ch.y + 'px';
    }

    function updateChests(dt) {
        const gameRect = gameEl.getBoundingClientRect();
        for (let i = chests.length - 1; i >= 0; i--) {
            const ch = chests[i];
            if (ch.state === 'hit' || ch.state === 'dead') continue;
            ch.y += WATER_SPEED * dt;
            updateChestElement(ch);
            if (ch.y > gameRect.height + 60) {
                if (ch.timer) clearInterval(ch.timer);
                ch.el.remove();
                chests.splice(i, 1);
            }
        }
    }

    function showChestBonus(ch, bonus) {
        const gameRect  = gameEl.getBoundingClientRect();
        const chestRect = ch.el.getBoundingClientRect();
        const x = chestRect.left + chestRect.width / 2 - gameRect.left;
        const y = chestRect.top  - gameRect.top - 10;

        const el = document.createElement('div');
        el.className = 'bonus-text';
        el.textContent = '+x' + bonus.toFixed(2);
        el.style.left = x + 'px';
        el.style.top  = y + 'px';
        gameEl.appendChild(el);
        el.addEventListener('animationend', () => el.remove());
    }

    function checkChestCollisions() {
        if (state !== 'running') return;
        const boatRect = boatWrap.getBoundingClientRect();
        for (const ch of chests) {
            if (ch.state !== 'idle') continue;
            const r = ch.el.getBoundingClientRect();
            const overlap = !(
                r.right < boatRect.left ||
                r.left  > boatRect.right ||
                r.bottom< boatRect.top ||
                r.top   > boatRect.bottom
            );
            if (overlap) {
                startChestHitAnimation(ch);

                const bonus = 0.2 + Math.random() * 4.8;
                multiplier += bonus;
                updateMultiplierUI();
                showChestBonus(ch, bonus);
            }
        }
    }

    function clearAllChests() {
        for (const ch of chests) {
            if (ch.timer) clearInterval(ch.timer);
            ch.el.remove();
        }
        chests.length = 0;
        chestCooldown = 0;
        lastChestGroupCenterX = null;
    }

    /* -------- Стороны: 22 картинки, парами + вертикальный сдвиг ---------- */

    function randomSideImage() {
        const idx = Math.floor(Math.random() * SIDE_COUNT);
        return sideImages[idx];
    }

    function assignSidePair(pair) {
        if (Math.random() > SIDE_CHANCE) {
            pair.leftEl.style.backgroundImage  = 'none';
            pair.rightEl.style.backgroundImage = 'none';
            pair.offset = 0;
            return;
        }
        const leftSrc  = randomSideImage();
        const rightSrc = randomSideImage();
        pair.leftEl.style.backgroundImage  = `url("${leftSrc}")`;
        pair.rightEl.style.backgroundImage = `url("${rightSrc}")`;
        pair.offset = (Math.random()*2 - 1) * 80; // вверх/вниз
    }

    function initBackground() {
        if (bgInitialized) return;
        bgInitialized = true;
        const vh = window.innerHeight;

        for (let i = 0; i < 2; i++) {
            const leftStrip  = document.createElement('div');
            const rightStrip = document.createElement('div');
            leftStrip.className  = 'bg-strip';
            rightStrip.className = 'bg-strip';
            sideLeft.appendChild(leftStrip);
            sideRight.appendChild(rightStrip);

            const baseY = (i === 0) ? 0 : -vh;
            const pair = { leftEl: leftStrip, rightEl: rightStrip, baseY, offset: 0 };
            assignSidePair(pair);
            leftStrip.style.transform  = `translateY(${pair.baseY + pair.offset/2}px)`;
            rightStrip.style.transform = `translateY(${pair.baseY - pair.offset/2}px)`;
            sidePairs.push(pair);
        }
    }

    /* -------- Вода: частицы, волны -------- */
    function spawnBubble() {
        const el = document.createElement('div');
        el.className = 'bubble';
        const rect = gameEl.getBoundingClientRect();
        const x = Math.random() * rect.width;
        const y = Math.random() * rect.height;
        const size = 3 + Math.random() * 3;
        el.style.left = x + 'px';
        el.style.top  = y + 'px';
        el.style.width  = size + 'px';
        el.style.height = size + 'px';
        waterFx.appendChild(el);
        el.addEventListener('animationend', () => el.remove());
    }

    function spawnWave() {
        const el = document.createElement('div');
        el.className = 'water-wave';
        const rect = gameEl.getBoundingClientRect();
        const x = Math.random() * rect.width;
        const y = rect.height * 0.3 + Math.random()*rect.height*0.4;
        el.style.left = x + 'px';
        el.style.top  = y + 'px';
        waterFx.appendChild(el);
        el.addEventListener('animationend', () => el.remove());
    }

    /* -------- Фоновый loop -------- */

    function startBgScroll() {
        initBackground();
        if (scrolling) return;
        scrolling = true;
        lastTime = performance.now();
        requestAnimationFrame(bgLoop);
    }
    function stopBgScroll() { scrolling = false; }

    function bgLoop(time) {
        if (!scrolling) return;
        const dt = (time - lastTime)/1000;
        lastTime = time;
        const vh = window.innerHeight;

        // стороны
        sidePairs.forEach(p => {
            p.baseY += WATER_SPEED*dt;
            if (p.baseY >= vh) {
                p.baseY -= vh*2;
                assignSidePair(p);
            }
            p.leftEl.style.transform  = `translateY(${p.baseY + p.offset/2}px)`;
            p.rightEl.style.transform = `translateY(${p.baseY - p.offset/2}px)`;
        });

        // сундуки
        updateChests(dt);
        chestCooldown -= dt;
        if (chestCooldown <= 0) {
            if (Math.random() < 0.5) {
                spawnChestGroup();
            }
            chestCooldown = 4 + Math.random() * 4;
        }
        checkChestCollisions();

        // вода
        bubbleTimer -= dt;
        if (bubbleTimer <= 0) {
            spawnBubble();
            bubbleTimer = 0.15 + Math.random() * 0.4;
        }
        waveTimer -= dt;
        if (waveTimer <= 0) {
            spawnWave();
            waveTimer = 1.2 + Math.random() * 1.5;
        }

        requestAnimationFrame(bgLoop);
    }

    /* -------- Результат и уплытие -------- */
    function animateWinAmount(target) {
        let current = 0;
        const duration = 800;
        const fps = 30;
        const step = target / (duration / (1000 / fps));
        const timer = setInterval(() => {
            current += step;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            resultWinEl.textContent = '+' + current.toFixed(2) + ' ₽';
        }, 1000 / fps);
    }
    function playSailAway() {
        boatWrap.style.setProperty('--boat-x', boatOffsetX + 'px');
        boatWrap.classList.add('sail-away');
    }
    function showResult() {
        const bet = getBet();
        const win = bet * multiplier;
        demoBalance += win;
        balanceValueEl.textContent = demoBalance.toFixed(2);
        resultMultEl.textContent = 'x' + multiplier.toFixed(2);
        lastMultEl.textContent   = multiplier.toFixed(2) + 'x';
        cashoutAmount.textContent = win.toFixed(2) + ' ₽';

        multiplierEl.classList.add('hidden');
        resultBlock.classList.remove('hidden');
        betMain.classList.add('hidden');
        cashoutMain.classList.add('visible');

        animateWinAmount(win);
        playSailAway();
    }
    function resetGame() {
        state = 'idle';
        multiplier = 1;
        updateMultiplierUI();
        multiplierEl.classList.remove('hidden');

        resultBlock.classList.add('hidden');
        betMain.classList.remove('hidden');
        cashoutMain.classList.remove('visible');
        boatTargetOffsetX = 0;
        boatOffsetX = 0;
        applyBoatTransform();
        clearAllChests();
    }
    cashoutMain.addEventListener('click', resetGame);

    /* -------- Удержание кнопки -------- */
    holdBtn.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        if (state !== 'idle') return;
        const bet = getBet();
        if (!bet) {
            betInput.classList.add('error');
            return;
        }
        betInput.classList.remove('error');
        state = 'running';
        resultBlock.classList.add('hidden');
        boatWrap.classList.remove('sail-away');
        activePointerId = e.pointerId;
        holdBtn.setPointerCapture(e.pointerId);
        dragStartX = e.clientX;
        dragStartOffset = boatOffsetX;
        startGrowing();
        startBgScroll();
    });
    holdBtn.addEventListener('pointermove', handleBoatMove);
    ['pointerup','pointerleave','pointercancel'].forEach(ev => {
        holdBtn.addEventListener(ev, (e) => {
            e.preventDefault();
            if (state !== 'running') return;
            if (e.pointerId === activePointerId) {
                try { holdBtn.releasePointerCapture(e.pointerId); } catch(_) {}
                activePointerId = null;
            }
            state = 'finished';
            stopGrowing();
            stopBgScroll();
            showResult();
        });
    });

    /* -------- Старт -------- */
    setBet(getBet() || 1);
    updateMultiplierUI();
    balanceValueEl.textContent = demoBalance.toFixed(2);
    applyBoatTransform();
</script>
</body>
</html>